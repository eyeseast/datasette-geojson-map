{"version":3,"file":"map.js","sources":["../../src/map.js"],"sourcesContent":["/*\nRender a map based on a query or table view by fetching its GeoJSON representation\n*/\n\nasync function render() {\n\tconsole.debug(\"Rendering GeoJSON map\");\n\n\t// load dependencies\n\tawait Promise.all([\n\t\tloadCSS(window.datasette.leaflet.CSS_URL),\n\t\timport(window.datasette.leaflet.JAVASCRIPT_URL),\n\t]);\n\n\tawait import(\"leaflet-simplestyle\");\n\n\tconst geojson = await fetch(geojsonURL(window.location)).then(r => r.json());\n\n\tconst parent = document.querySelector(\".table-wrapper\");\n\tconst container = document.createElement(\"DIV\");\n\n\tObject.assign(container, {\n\t\tid: \"map\",\n\t});\n\n\tparent.insertBefore(container, parent.firstElementChild);\n\n\tconst map = createMap(window.L, container);\n\tconst layer = L.geoJSON(geojson, {\n\t\tuseSimpleStyle: window.TILE_LAYER_OPTIONS.use_simplestyle,\n\t\tuseMakiMarkers: window.TILE_LAYER_OPTIONS.use_maki_icons,\n\t})\n\t\t.addTo(map)\n\t\t.bindPopup(popup);\n\n\tconst bounds = getBounds(layer, window.L);\n\n\tmap.fitBounds(bounds);\n\tmap.on(\"moveend\", updateBounds);\n\n\t// make debugging easier\n\twindow.map = map;\n}\n\nfunction loadCSS(href) {\n\tconst link = document.createElement(\"link\");\n\n\tObject.assign(link, { href, rel: \"stylesheet\" });\n\n\tdocument.head.appendChild(link);\n\n\treturn new Promise((resolve, reject) => {\n\t\tlink.addEventListener(\"load\", resolve);\n\t\tlink.addEventListener(\"error\", reject);\n\t});\n}\n\nfunction createMap(L, container) {\n\tconst map = L.map(container);\n\n\tL.tileLayer(window.TILE_LAYER, window.TILE_LAYER_OPTIONS).addTo(map);\n\n\treturn map;\n}\n\nfunction geojsonURL(location) {\n\tconst url = new URL(location);\n\turl.pathname = url.pathname + \".geojson\";\n\treturn url;\n}\n\nfunction popup(layer) {\n\tconst { properties } = layer.feature;\n\tconst items = Object.entries(properties).map(\n\t\t([key, value]) => `\n  <dt>${key}</dt>\n  <dd class=\"${typeof value}\">${format(value)}</dd>`\n\t);\n\n\treturn `<dl class=\"properties\">${items.join(\"\")}</dl>`;\n}\n\nfunction format(value) {\n\tswitch (typeof value) {\n\t\tcase \"number\":\n\t\t\treturn value.toLocaleString();\n\n\t\tcase \"string\":\n\t\t\treturn value;\n\n\t\tdefault:\n\t\t\treturn String(value);\n\t}\n}\n\nfunction renderBBoxInput() {}\n\nfunction renderSplitBoundsInput() {}\n/**\n * Get bounds for the GeoJSON layer,\n * unless we have a _bbox or other params set\n *\n * @param {*} layer\n */\nfunction getBounds(layer, L) {\n\tconst qs = new URL(window.location).searchParams;\n\n\tif (qs.has(\"_bbox\")) {\n\t\tconst [x1, y1, x2, y2] = qs.get(\"_bbox\").split(\",\").map(Number);\n\t\treturn L.latLngBounds([y1, x1], [y2, x2]);\n\t}\n\n\tif ([\"x1\", \"y1\", \"x2\", \"y2\"].every(f => qs.has(f))) {\n\t\tconst [x1, y1, x2, y2] = [\"x1\", \"y1\", \"x2\", \"y2\"].map(f => qs.get(f)).map(Number);\n\t\treturn L.latLngBounds([y1, x1], [y2, x2]);\n\t}\n\n\treturn layer.getBounds();\n}\n\nfunction updateBounds(e) {}\n\nwindow.addEventListener(\"load\", render);\n"],"names":[],"mappings":"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"}